{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block content %}

<h2 class="page-title">Telegrama de carga de votos</h2>

<!-- Overlay de guardado (feedback visual) -->
<style>
  .saving-overlay{position:fixed;inset:0;background:rgba(255,255,255,.6);
    display:flex;align-items:center;justify-content:center;font-weight:600;
    font-size:1.1rem;z-index:9999}
  .saving-overlay[hidden]{display:none;}
</style>
<div id="saving_overlay" class="saving-overlay" hidden>Guardando mesa…</div>

<!-- Contenedor de notificaciones sutiles -->
<div id="noti-container" class="noti-container"></div>

<form method="POST">
  {% csrf_token %}

  <!-- DATOS DE MESA + TABLA SECUNDARIA -->
  <div class="mesa-datos-container">
    <!-- DATOS -->
    <fieldset class="resumen-mesa">
      <legend>Datos de la mesa</legend>

      <table class="tabla_telegrama">
        <tbody>
          <tr>
            <td>Escuela</td>
            <td>
              <input type="text" value="{{ escuela_nombre }}" readonly class="w-100">
            </td>
          </tr>
          <tr>
            <td>Mesa</td>
            <td>
              <select id="mesa_select" class="w-100">
                <option value="">-- Seleccionar mesa --</option>
                {% for m in mesas %}
                  <option value="{{ m.id }}" data-escrutada="{{ m.escrutada|default:0 }}">
                    Mesa {{ m.numero_mesa }}{% if m.escrutada %} (✓ escrutada){% endif %}
                  </option>
                {% endfor %}
              </select>
              <div id="mensaje_error_mesa" class="error-msg"></div>
            </td>
          </tr>
        </tbody>
      </table>

      <input type="hidden" id="mesa_id" name="mesa_id">
    </fieldset>

    <!-- RESUMEN -->
    <fieldset class="resumen-mesa">
      <legend>Resumen de la mesa</legend>
      <table class="tabla_telegrama">
        <thead>
          <tr>
            <th></th>
            <th>En N°</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Cantidad de electores que han votado</td>
            <td><input type="number" id="electores_votaron" name="total_votantes" class="input_corto" required></td>
          </tr>
          <tr>
            <td>Cantidad de sobres utilizados en la urna</td>
            <td><input type="number" id="sobres_encontrados" name="sobres_utilizados" class="input_corto" required></td>
          </tr>
          <tr>
            <td>Diferencia</td>
            <td><input type="number" id="diferencia_sobres" name="diferencia_sobres" class="input_corto" required></td>
          </tr>
        </tbody>
      </table>
    </fieldset>
  </div>

  <!-- =========================
       MODO MÓVIL: TARJETAS
       ========================= -->
  <div class="only-mobile">

    <!-- DIPUTADOS PROVINCIALES -->
    <section class="cargo-cards">
      <h3 class="cargo-title">Diputados Provinciales</h3>

      <div id="cards_diputados" class="cards-grid">
        {% for grupo in partidos_map %}
          {% for cargo in cargos %}
            {% if cargo.nombre_postulacion == "Diputados Provinciales" %}
              {% with candidatura=grupo.candidaturas|dict_key:cargo.id %}
                {% if candidatura %}
                  <article class="card-partido">
                    <div class="card-header">
                      <div class="num">{{ grupo.partido.numero_lista }}</div>
                      <div class="nombre">{{ grupo.partido.nombre_partido }}</div>
                    </div>
                    <div class="card-body">
                      <label class="sr-only" for="v_{{ candidatura.id }}">Votos</label>
                      <input id="v_{{ candidatura.id }}"
                            type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                            class="voto_input"
                            data-cargo="{{ cargo.id }}"
                            data-partido="{{ candidatura.id }}"
                            oninput="calcularTotales()"
                            placeholder="000">
                    </div>
                  </article>
                {% else %}
                  <!-- Card para los que NO postulan (Diputados - móvil) -->
                  <article class="card-partido no-postula" aria-disabled="true">
                    <div class="card-header">
                      <div class="num">{{ grupo.partido.numero_lista }}</div>
                      <div class="nombre">{{ grupo.partido.nombre_partido }}</div>
                      <span class="badge-no-postula">No postula</span>
                    </div>
                    <div class="card-body">
                      <div class="no-usa">(no usar)</div>
                    </div>
                  </article>
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>

      <!-- Especiales -->
      <div class="especiales-grid">
        {% for cargo in cargos %}
          {% if cargo.nombre_postulacion == "Diputados Provinciales" %}
            {% for tipo in tipos_voto_especial %}
              <div class="esp-item">
                <label>Votos {{ tipo|title }}</label>
                <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                       class="voto_especial_input"
                       data-cargo="{{ cargo.id }}"
                       data-tipo="{{ tipo }}"
                       oninput="calcularTotales()"
                       placeholder="000">
              </div>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>

      <!-- Totales -->
      <div class="totales-cargo">
        {% for cargo in cargos %}
          {% if cargo.nombre_postulacion == "Diputados Provinciales" %}
            <div class="total-row">
              <span>Total votos agrupaciones políticas</span>
              <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                     data-total-cargo="{{ cargo.id }}" readonly placeholder="000">
            </div>
            <div class="total-row">
              <span>SUMA TOTAL DE VOTOS</span>
              <input type="number" id="total_agrupaciones_{{ cargo.id }}">
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    <!-- CONCEJALES -->
    <section class="cargo-cards">
      <h3 class="cargo-title">Concejales</h3>

      <div id="cards_concejales" class="cards-grid">
        {% for grupo in partidos_map %}
          {% for cargo in cargos %}
            {% if cargo.nombre_postulacion == "Concejales" %}
              {% with candidatura=grupo.candidaturas|dict_key:cargo.id %}
                {% if candidatura %}
                  <article class="card-partido">
                    <div class="card-header">
                      <div class="num">{{ grupo.partido.numero_lista }}</div>
                      <div class="nombre">{{ grupo.partido.nombre_partido }}</div>
                    </div>
                    <div class="card-body">
                      <label class="sr-only" for="v_{{ candidatura.id }}">Votos</label>
                      <input id="v_{{ candidatura.id }}"
                            type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                            class="voto_input"
                            data-cargo="{{ cargo.id }}"
                            data-partido="{{ candidatura.id }}"
                            oninput="calcularTotales()"
                            placeholder="000">
                    </div>
                  </article>
                {% else %}
                  <!-- Card para los que NO postulan -->
                  <article class="card-partido no-postula" aria-disabled="true">
                    <div class="card-header">
                      <div class="num">{{ grupo.partido.numero_lista }}</div>
                      <div class="nombre">{{ grupo.partido.nombre_partido }}</div>
                      <span class="badge-no-postula">No postula</span>
                    </div>
                    <div class="card-body">
                      <div class="no-usa">(no usar)</div>
                    </div>
                  </article>
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>

      <!-- Especiales -->
      <div class="especiales-grid">
        {% for cargo in cargos %}
          {% if cargo.nombre_postulacion == "Concejales" %}
            {% for tipo in tipos_voto_especial %}
              <div class="esp-item">
                <label>Votos {{ tipo|title }}</label>
                <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                       class="voto_especial_input"
                       data-cargo="{{ cargo.id }}"
                       data-tipo="{{ tipo }}"
                       oninput="calcularTotales()"
                       placeholder="000">
              </div>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>

      <!-- Totales -->
      <div class="totales-cargo">
        {% for cargo in cargos %}
          {% if cargo.nombre_postulacion == "Concejales" %}
            <div class="total-row">
              <span>Total votos agrupaciones políticas</span>
              <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                     data-total-cargo="{{ cargo.id}}" readonly placeholder="000">
            </div>
            <div class="total-row">
              <span>SUMA TOTAL DE VOTOS</span>
              <input type="number" id="total_agrupaciones_{{ cargo.id }}">
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    <div id="mensaje_validacion"></div>
    <button type="button" class="btn-enviar-votos">Enviar votos</button>
  </div>
  <!-- /only-mobile -->

  <!-- =========================
       ESCRITORIO/TABLET (tabla)
       ========================= -->
  <div class="only-landscape">
    <div class="tabla-votos-wrap">
      <table border="1" cellpadding="5" cellspacing="0" id="tabla_votos">
        <thead>
          <tr>
            <th class="col-index">N°</th>
            <th class="col-agrupa">Agrupación Política</th>
            {% for cargo in cargos %}
              {% if cargo.nombre_postulacion == "Diputados Provinciales" or cargo.nombre_postulacion == "Concejales" %}
                <th class="col-cargo col-cargo-{{ cargo.id }}" data-cargo="{{ cargo.id }}">
                  {{ cargo.nombre_postulacion }}
                </th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for grupo in partidos_map %}
          <tr>
            <td class="col-index">{{ grupo.partido.numero_lista }}</td>
            <td class="col-agrupa">{{ grupo.partido.nombre_partido }}</td>

            {% for cargo in cargos %}
              {% if cargo.nombre_postulacion == "Diputados Provinciales" or cargo.nombre_postulacion == "Concejales" %}
                {% with candidatura=grupo.candidaturas|dict_key:cargo.id %}
                  {% if candidatura %}
                    <td class="col-cargo col-cargo-{{ cargo.id }}">
                      <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                             name="votos_{{ candidatura.id }}"
                             class="voto_input"
                             data-cargo="{{ cargo.id }}"
                             data-partido="{{ candidatura.id }}"
                             oninput="calcularTotales()"
                             placeholder="000">
                    </td>
                  {% else %}
                    <td class="col-cargo col-cargo-{{ cargo.id }} no-postula">(no usar)</td>
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr>
            <td></td>
            <td><strong>Total votos agrupaciones políticas</strong></td>
            {% for cargo in cargos %}
              {% if cargo.nombre_postulacion == "Diputados Provinciales" or cargo.nombre_postulacion == "Concejales" %}
                <td class="col-cargo col-cargo-{{ cargo.id }}">
                  <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                         data-total-cargo="{{ cargo.id }}" readonly placeholder="000">
                </td>
              {% endif %}
            {% endfor %}
          </tr>

          {% for tipo in tipos_voto_especial %}
          <tr>
            <td></td>
            <td><strong>Votos {{ tipo|title }}</strong></td>
            {% for cargo in cargos %}
              {% if cargo.nombre_postulacion == "Diputados Provinciales" or cargo.nombre_postulacion == "Concejales" %}
                <td class="col-cargo col-cargo-{{ cargo.id }}">
                  <input type="text" inputmode="numeric" maxlength="3" pattern="\d{0,3}"
                         name="votos_{{ tipo }}_{{ cargo.id }}"
                         class="voto_especial_input"
                         data-tipo="{{ tipo }}"
                         data-cargo="{{ cargo.id }}"
                         oninput="calcularTotales()"
                         placeholder="000">
                </td>
              {% endif %}
            {% endfor %}
          </tr>
          {% endfor %}

          <tr>
            <td></td>
            <td><strong>SUMA TOTAL DE VOTOS</strong></td>
            {% for cargo in cargos %}
              {% if cargo.nombre_postulacion == "Diputados Provinciales" or cargo.nombre_postulacion == "Concejales" %}
                <td class="col-cargo col-cargo-{{ cargo.id }}">
                  <input type="number" id="total_agrupaciones_{{ cargo.id }}">
                </td>
              {% endif %}
            {% endfor %}
          </tr>
        </tfoot>
      </table>
    </div>

    <div id="mensaje_validacion"></div>
    <button type="button" class="btn-enviar-votos">Enviar votos</button>
  </div>
  <!-- /only-landscape -->

</form>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/operador.js' %}"></script>
{% endblock %}
