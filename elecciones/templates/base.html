{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Sistema de Escrutinio{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#31b8f0">

  <!-- Evitar cacheo del HTML en autenticados -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  {% block extra_head %}{% endblock %}
</head>

<!-- Marcamos clase por rol. Si el usuario es operador, agregamos 'operador' al body-->

<body class="{% if request.user.is_authenticated and request.user.role == 'operador' %}operador{% endif %} {% block body_class %}{% endblock %}">
  <header class="container">
    <nav class="header-nav">
      <div><strong>Sistema de Escrutinio</strong></div>
      <div class="links">
        {# Mostrar enlaces SOLO si NO es operador #}
        {% if request.user.is_authenticated and request.user.role != 'operador' %}
          <a href="{% url 'panel_dashboard' %}" {% if request.resolver_match.url_name == 'panel_dashboard' %}aria-current="page"{% endif %}>Panel</a>
          <a href="{% url 'panel_graficos' %}" {% if request.resolver_match.url_name == 'panel_graficos' %}aria-current="page"{% endif %}>Gráficos</a>
          <a href="{% url 'panel_resultados' %}" {% if request.resolver_match.url_name == 'panel_resultados' %}aria-current="page"{% endif %}>Resultados</a>
        {% endif %}
        {# Botón de cierre de sesión siempre visible a autenticados #}
        {% if request.user.is_authenticated %}
          <a id="btn-logout" href="{% url 'logout' %}">Cerrar sesión</a>
        {% endif %}
      </div>
    </nav>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  {% if request.user.is_authenticated and request.user.role == 'operador' %}
  <script>
    // Limpieza al "salir" (cambiar página, cerrar pestaña, ir atrás, etc.)
    (function(){
      async function clearLocalStuff(){
        try { localStorage.clear(); } catch(e){}
        try { sessionStorage.clear(); } catch(e){}
        try {
          if (window.indexedDB) {
            const dbs = await (indexedDB.databases ? indexedDB.databases() : Promise.resolve([]));
            for (const d of dbs) {
              try {
                await new Promise((ok,ko)=>{ const r = indexedDB.deleteDatabase(d.name); r.onsuccess=ok; r.onerror=ko; r.onblocked=ok; });
              } catch(e){}
            }
          }
        } catch(e){}
        try {
          if (window.caches?.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        } catch(e){}
        try {
          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
        } catch(e){}
      }

      // Al intentar abandonar la página
      window.addEventListener('pagehide', clearLocalStuff);
      window.addEventListener('beforeunload', clearLocalStuff);

      // Si querés forzar limpieza adicional al cerrar sesión manualmente,
      // podés interceptar el click y dejar que el servidor redirija luego:
      const btnLogout = document.getElementById('btn-logout');
      if (btnLogout) {
        btnLogout.addEventListener('click', async (ev) => {
          // No prevenimos la navegación: el servidor devolverá la página de logout con redirección
          // pero iniciamos limpieza inmediata del lado cliente
          try { await clearLocalStuff(); } catch(e){}
        });
      }
    })();
  </script>
  {% endif %}

  {% block extra_scripts %}{% endblock %}
</body>
</html>
